#!/bin/sh

. "${ICD_SHARE_DIR}/error.script"
. "${ICD_SHARE_DIR}/network.script"

read_static_ip_config()
{
  local dns1 dns2

  ip=`icd-config --db="${ICD_CONFIG_DB}" get tcpip ip | cut -d: -f3`
  subnet=`icd-config --db="${ICD_CONFIG_DB}" get tcpip mask | cut -d: -f3`
  router=`icd-config --db="${ICD_CONFIG_DB}" get tcpip gate | cut -d: -f3`
  dns1=`icd-config --db="${ICD_CONFIG_DB}" get tcpip dns1 | cut -d: -f3`
  dns2=`icd-config --db="${ICD_CONFIG_DB}" get tcpip dns2 | cut -d: -f3`

  if [ "x${dns1}" != "x" -a "x${dns2}" != "x" ]; then
    dns="${dns1} ${dns2}"
  elif [ "x${dns1}" != "x" ]; then
    dns="${dns1}"
  elif [ "x${dns2}" != "x" ]; then
    dns="${dns2}"
  else
    dns=""
  fi
}

start_network()
{
  local ip broadcast subnet router dns

  ifup=`icd-config --db="${ICD_CONFIG_DB}" get current ifup | cut -d: -f3`
  test "x${ifup}" == "x"
  exit_on_error "Network already configured"

  print_info "Starting network..."

  ifconfig ${interface} up

  dhcp=`icd-config --db="${ICD_CONFIG_DB}" get tcpip dhcp | cut -d: -f3`

  if [ "$dhcp" == "yes" -o "$dhcp" == "true" -o "$dhcp" == "1" ]; then
    print_info "Starting dhcp client..."
    udhcpc -i ${interface} -t 3 -R -S -s "${ICD_SHARE_DIR}/udhcpc.script"
    warn_on_error "Starting dhcp client failed"

    icd-config --db="${ICD_CONFIG_DB}" set current ifup yes set current dhcp yes
    warn_on_error "Updating current config failed"

  elif [ "x$dhcp" == "x" -o "$dhcp" == "no" -o "$dhcp" == "false" -o "$dhcp" == "0" ]; then
    read_static_ip_config
    setup_interface

    icd-config --db="${ICD_CONFIG_DB}" set current ifup yes set current dhcp no
    warn_on_error "Updating current config failed"

  else
    print_info "${program_name}: Error! Reading config entry failed."
    print_info "${program_name}: Program halted."
    exit 1

  fi
}

stop_network()
{
  local cmd

  ifup=`icd-config --db="${ICD_CONFIG_DB}" get current ifup | cut -d: -f3`
  test "${ifup}" == "yes"
  exit_on_error "Network not configured"

  print_info "Stopping network..."

  print_info "Stopping dhcp client (if started)"
  start-stop-daemon -n udhcpc -o -K

  setdown_interface

  ifconfig ${interface} down

  cmd="icd-config --db=\"${ICD_CONFIG_DB}\""
  cmd=${cmd}" set current ifup \"\""
  cmd=${cmd}" set current dhcp \"\""
  eval ${cmd}
  warn_on_error "Updating current config failed"
}

program_name=`basename "$0"`
interface="eth0"

case "$1" in
  start)
    start_network
    ;;
  stop)
    stop_network
    ;;

  restart|reload)
    stop_network
    start_network
    ;;

  *)
    print_info "Usage: ${program_name} {start|stop|restart}"
    exit 1
esac

exit 0

