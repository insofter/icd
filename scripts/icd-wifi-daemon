#!/bin/sh

while [ 1 = 1 ]
do
  sleep 30

  if [ "`icd-config --db=$ICD_CONFIG_DB sget wifi enabled`" = "yes" ]
  then #wifi should be running

    if ! [ -e /tmp/wpa_suppl.conf ]
    then
      icd-wifi-cfg-from
    fi

    if [ "`pidof wpa_supplicant > /dev/null && echo yes || echo no`" = "no" ]
    then
      wpa_supplicant -Dwext -iwlan0 -d -c/tmp/wpa_suppl.conf > /dev/null &
      sleep 3
    fi


    if [ "`ps | grep -q "[u]dhcpc -i wlan0" && echo yes || echo no`" = "no" ] 
    then
      if [ "`pidof wpa_supplicant > /dev/null && echo yes || echo no`" = "yes" ]
      then
        udhcpc -i wlan0 > /dev/null 2>&1 &
      fi
    fi

    icd-wifi-cfg-to

  else #wifi should not be running

    if [ "`ps | grep -q "[u]dhcpc -i wlan0" && echo yes || echo no`" = "yes" ]
    then
      kill `ps | awk ''/'[u]dhcpc -i wlan0'/' { print $1}'`
    fi

    if [ "`pidof wpa_supplicant > /dev/null && echo yes || echo no`" = "yes" ]
    then
      killall wpa_supplicant
      sleep 3
      icd-wifi-cfg-to
    fi

    if [ -e /tmp/wpa_suppl.conf ]
    then
      rm -f /tmp/wpa_suppl.conf
    fi

  fi
done


#TODO
#cfg_from() {
#touch /tmp/log/wpa_supplicant.log
#chmod 644 /tmp/log/wpa_supplicant.log
#touch /tmp/log/udhcpc.log
#chmod 644 /tmp/log/udhcpc.log
#log size
#du /tmp/log/wpa_supplicant.log
#}

