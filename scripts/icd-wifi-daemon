#!/bin/sh

cat << EOWPASUPPLCONF > /tmp/wpa_suppl.conf
ctrl_interface=/var/run/wpa_supplicant
ctrl_interface_group=wheel
update_config=1

network={
  ssid="IFirma"
  psk="Insofter8971002738"
  key_mgmt=WPA-PSK
  auth_alg=OPEN
}

network={
  ssid="insofter"
  psk="insofter"
  key_mgmt=WPA-PSK
  auth_alg=OPEN
}
EOWPASUPPLCONF

touch /tmp/log/wpa_supplicant.log
chmod 644 /tmp/log/wpa_supplicant.log

touch /tmp/log/udhcpc.log
chmod 644 /tmp/log/udhcpc.log

while [ 1 = 1 ]
do
  sleep 30

  #TODO: chceck wifi enabled from db


  #check if wpa_suppl is running or run it
  pidof wpa_supplicant || wpa_supplicant -Dwext -iwlan0 -d -c/tmp/wpa_suppl.conf > /tmp/log/wpa_supplicant.log &

  sleep 5

  #check if wpa_suppl is running and check if udhcpc -i wlan0 is running or run it
  pidof wpa_supplicant && ps | grep "udhcpc -i wlan0" | grep -q -v grep || udhcpc -i wlan0 > /tmp/log/udhcpc.log 2>&1 &

done
