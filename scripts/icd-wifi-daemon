#!/bin/sh
i=0

while [ 1 = 1 ]
do
  sleep 30

  if [ "`icd-config --db=$ICD_CONFIG_DB sget wifi enabled`" = "yes" ]
  then #wifi should be running

    if ! [ -e /tmp/wpa_suppl.conf ]
    then
      icd-wifi-cfg-from
      echo `date` ":: Config from db"
    fi

    if [ "`pidof wpa_supplicant > /dev/null && echo yes || echo no`" = "no" ]
    then
      wpa_supplicant -Dwext -iwlan0 -d -c/tmp/wpa_suppl.conf 2>&1 | icd-logrotate /tmp/log/wifi_wpa_suppl.log &
      sleep 3
      echo `date` ":: Start wpa_supplicant"
    fi


    if [ "`ps | grep -q "[u]dhcpc -i wlan0" && echo yes || echo no`" = "no" ] 
    then
      if [ "`pidof wpa_supplicant > /dev/null && echo yes || echo no`" = "yes" ]
      then
        udhcpc -i wlan0 2>&1 | icd-logrotate /tmp/log/wifi_udhcpc.log &
        echo `date` ":: Start udhcpc"
      fi
    fi

    if [ "`wpa_cli -i wlan0 status 2>/dev/null | grep -v bssid | awk -F '=' ''/'ssid'/' {print $2}' | wc -c`" -lt 2 ] 
    then #30*30s = 15min without connection, try reset everything
      if [ "`wpa_cli -i wlan0 status 2>/dev/null | awk -F '=' ''/'ip_address'/' {print $2}' | wc -c`" -lt 2 ]
      then
        i=$(( $i+1 ))
        if [ "$i" -gt 30 ]
        then
          i=0
          kill `ps | awk ''/'[u]dhcpc -i wlan0'/' { print $1}'`
          echo `date` ":: Stop udhcpc"
          killall wpa_supplicant
          sleep 3
          icd-wifi-cfg-to
          echo `date` ":: Stop wpa_supplicant"
          rm -f /tmp/wpa_suppl.conf
          echo `date` ":: Remove from db"
        fi
      fi
    fi

    icd-wifi-cfg-to


  else #wifi should not be running

    if [ "`ps | grep -q "[u]dhcpc -i wlan0" && echo yes || echo no`" = "yes" ]
    then
      kill `ps | awk ''/'[u]dhcpc -i wlan0'/' { print $1}'`
      echo `date` ":: Stop udhcpc"
    fi

    if [ "`pidof wpa_supplicant > /dev/null && echo yes || echo no`" = "yes" ]
    then
      killall wpa_supplicant
      sleep 3
      icd-wifi-cfg-to
      echo `date` ":: Stop wpa_supplicant"
    fi

    if [ -e /tmp/wpa_suppl.conf ]
    then
      rm -f /tmp/wpa_suppl.conf
      echo `date` ":: Remove from db"
    fi

  fi
done


